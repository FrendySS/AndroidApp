# Используем образ с Java 17 (подходит для Android AGP 8.0+)
image: openjdk:17-jdk

variables:
  # Версии Android SDK
  ANDROID_COMPILE_SDK: "35"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "9477386"  # Последняя версия из https://developer.android.com/studio

  # Опции Gradle (отключаем демона для CI)
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true"

# Кеширование (ускоряет повторные сборки)
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .gradle/
    - build/
    - android-sdk/  # Кешируем SDK, если не хотим качать каждый раз

# Этапы пайплайна
stages:
  - build
  - test
  - deploy

# Подготовка среды (Android SDK, лицензии)
before_script:
  - apt-get update -qq
  - apt-get install -y wget tar unzip lib32stdc++6 lib32z1
  - |
    if [ ! -d "android-sdk" ]; then
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O android-sdk.zip
      unzip -q android-sdk.zip -d android-sdk
      mkdir -p android-sdk/cmdline-tools/latest
      mv android-sdk/cmdline-tools/* android-sdk/cmdline-tools/latest
    fi
  - export ANDROID_HOME="$PWD/android-sdk"
  - export PATH="$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools"
  - yes | sdkmanager --licenses > /dev/null
  - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"
  - chmod +x ./gradlew

# Сборка APK и AAB
build:
  stage: build
  script:
    - ./gradlew assembleDebug assembleRelease  # Собираем обе версии
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
      - app/build/outputs/apk/release/
      - app/build/outputs/bundle/release/
    expire_in: 1 week  # Храним артефакты 7 дней

# Запуск тестов
test:
  stage: test
  script:
    - ./gradlew testDebugUnitTest  # Unit-тесты
    - ./gradlew connectedDebugAndroidTest  # Интеграционные тесты (нужен эмулятор!)
  dependencies:
    - build
  only:
    - merge_requests  # Тесты запускаем только для MR

# Деплой в Firebase App Distribution
deploy_to_firebase:
  stage: deploy
  script:
    - npm install -g firebase-tools  # Устанавливаем Firebase CLI
    - firebase appdistribution:distribute
        app/build/outputs/apk/release/app-release.apk
        --app "$FIREBASE_APP_ID"
        --groups "testers"
        --token "$FIREBASE_TOKEN"
  only:
    - main  # Деплоим только из main-ветки

# Альтернатива: деплой в Google Play (раскомментировать при необходимости)
#deploy_to_play:
#  stage: deploy
#  script:
#    - ./gradlew publishReleaseBundle
#  only:
#    - tags  # Деплоим только при создании тега (v1.0.0)