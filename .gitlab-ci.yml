image: alpine:latest  # Минимальный образ (всего 5MB)

variables:
  ANDROID_COMPILE_SDK: "35"
  ANDROID_BUILD_TOOLS: "35.0.0"
  JAVA_VERSION: "17"
  GRADLE_VERSION: "8.4"

stages:
  - setup
  - build
  - test

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .gradle/
    - android-sdk/

before_script:
  - apk update && apk add --no-cache wget unzip zip libstdc++ openjdk${JAVA_VERSION} 
  - export JAVA_HOME=/usr/lib/jvm/java-${JAVA_VERSION}-openjdk
  - export PATH=$PATH:$JAVA_HOME/bin

setup_android_sdk:
  stage: setup
  script:
    # Устанавливаем только необходимые компоненты
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -O sdk-tools.zip
    - unzip -q sdk-tools.zip -d android-sdk
    - yes | android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=$PWD/android-sdk 
      "platforms;android-${ANDROID_COMPILE_SDK}" 
      "build-tools;${ANDROID_BUILD_TOOLS}" 
      "platform-tools" 
      "ndk;25.2.9519653"
    - rm sdk-tools.zip
  artifacts:
    paths:
      - android-sdk/

build:
  stage: build
  script:
    - export ANDROID_HOME=$PWD/android-sdk
    - export PATH=$PATH:$ANDROID_HOME/platform-tools
    - wget -q https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
    - unzip -q gradle-${GRADLE_VERSION}-bin.zip
    - ./gradle-${GRADLE_VERSION}/bin/gradle assembleDebug
  artifacts:
    paths:
      - app/build/outputs/apk/debug/

test:
  stage: test
  script:
    - ./gradle-${GRADLE_VERSION}/bin/gradle testDebugUnitTest